---
title: "FlutterKaigi2025に行ってきました" # 記事のタイトル
emoji: "😸" # アイキャッチとして使われる絵文字（1文字だけ）
type: "idea" # tech: 技術記事 / idea: アイデア記事
topics: ["flutter"] # タグ。["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---


## セッションメモ

### 2. Flutterコントリビューションのすすめ

#### セッションメモ

- いろいろ言われるが身近な問題（工数がシンプルに足りない）では？
    - マクロとかやめちゃったけど、工数が有り余っていたらできてただろうなとは思う
- P1/P2はFlutterチームの見た人がそう思った以上の意図はないのでは？
- Flutter開発チームとアプリ開発チームの終着点のズレはある
- Flutterチームの優先度とかタスクとかって見えない
    - （たとえば）知らないDiscordのやり取りで決まったことを外野からあーだこーだいうのはまぁ不毛
- コードで殴ればいい
    - 火事が起きているのに「誰も、消防車を呼ばないのである！」　←issueはだいたいこれ
    - 自分で呼んだらいい
- コントロールできるものとできないものがあるが、自分で手を動かせばリスクが管理できる
- AIはあってもいいが、ちゃんと意図を説明できること
    - 「素人質問で恐縮ですが」くらいにはAI無しで耐えろ
- シンプルに経験値やマイノリティーの存在主張(=CJK環境)になる

#### 感想

- 別にFlutterに限らず各種パッケージとか、私的にはMisskeyについてもとてもいえる（というかほとんどそれに当てはめて聞いてた）し、自分が持ってるMiriaについて同じことを周囲が思ってるかもとはとても思った。
    - 火事が起きているって騒ぐなら消防車を呼べ（＝コードで殴れ）はそれは本当にそう
    - でもMisskeyとか見てると「気運がないから」クローズされるとかたまによく見る。でもフォークが拾ったりするしそれはOSSのエコシステムだと思う
    - 非常にハイコンテクストな話をすると、私は単なるサードパーティクライアント作者以上でも以下でもないので、Misskey本流やioがどうするどうしないとかの話はTLに流れてくる以上のことは知らない。なのでできる限りmisskey-dev/misskeyのAPI仕様に不満があるならコントリビューションで殴るべきだとは改めて思った
        - Misskeyのサードパーティ開発者ってまぁとても限られるし…

### 3. Impellerによって何が変わったのか

#### セッションメモ

- そもそもグラフィックスエンジンとか描画エンジンとは何ぞや　歴史から紐解こう
    - OpenGLが最初、MetalはAppleが勝手に言ってるやつ、VulkanはOpenGLのモダン化
    - グラフィックスAPIができること
        - 座標上に点を置いてつないで面にして描画する。
        - 描画するのにシェーダーを使う シェーダーはVRChatでUnity触って自作シェーダーとか作ったのでよくわかる
    - CPUでグラフィックスしようとするなら、x軸×y軸の全ピクセルループ！？それを120fps以内で！？みたいな話になる
        - GPUでできる処理って何？は実際にliltoonのカスタムシェーダーとか書いてみると何ができるか、何ができないかがよくわかった
- SkiaはシェーダージャンクのせいでiOSでパフォーマンス悪いとか言われてた
    - Impellerのモチベがそれなのは聞いたことあった
    - Google ChromeはSkiaを最適化するモチベがあるけどFlutterと方向性が必ずしも合ってない　だからFlutterチームは自分でやるぜ！（発想がだいぶゴリラ）

#### 感想

- VRChatのアバター改変でおぼえたシェーダーやGPUの仔細がこんなところで役に立つとは思わなかった　いろいろ手を出すのもありよりのあり
- というかFlutterGPUというのをはじめて知ったので何かVRChat向けアバターをFlutterウィジェットにできそうでは？みたいなことを思い始めた
    - liltoonを移植しろ（無理）

### 4. Flutterビルドキャッシュの内部構造とテスト高速化への応用

#### セッションメモ

- 結論はシンプル、ビルド時定数をテストケースごとに変えたら毎回ビルドが必要なので遅い
- ここに行き着くために実際のビルドシステムを紐解く
    - `frontend_server`はKernelコンパイラ(CFE)を常駐プロセスとしてラップしたもの
        - いつもプロセス一覧に居る君の正体はそういう役割だったんだね！のアハ体験
    - `dill`はKernelのバイナリ表現。 Dartコードからdillに変換するところがポイント
        - Javaでいう`.class`ファイルみたいなものかしら（あれはファイルごとに生成されるけど）
    - 要するに`dill`を生成する過程で`dart_defines`がハッシュ化されているので、一字一句違えば`dill`は作り直し。だから遅くなるんだね！

#### 感想

- なんとなくいつもそこにあるものが何をしているのかに触れられたのは楽しかった

### 5. Dart&Flutter MCP ServerでAI駆動E2Eテスト

#### セッションメモ

- 基本的にE2Eテストでやることは画面情報取得、解釈とアクションの決定、そして実行
- テストシナリオは先に書けるがテストコードは実装後にしか書けない
    - Gherkin記法を使うのがよい
- 画面情報取得：MCPに`get_widget_tree`があるが仕様が終わってる　本当に必要な情報が埋もれるしコンテキストあふれを起こす
    - 同じことを試みて同じところで詰まっている……
- だから絞った情報を返すDart VM Extensionを作った
    - このアプローチも一緒……
    - 自分の場合は基本的にラベルの情報があればなんとかなると思って子ウィジェットを走査してTextを拾ったなぁ
- MobileMCPを使うとOSネイティブ部分も操作可能（ただしFlutter側が逆に難しい）
- LLMが実際にはできないのにがんばろうとすることもある

#### 感想

- 同じようなことをやろうとしたセッションだと思って聞いていたが、同じところで詰まって似たような解決策を提示されていたのが面白かった
    - `get_widget_tree`がいらない情報を返しすぎるのは本当にそうで何なら`debugDumpApp`も何とかしてほしい。あれも人間が読むのにいらない情報が多すぎるしインデントが深すぎて見づらい
- 私の場合appium_flutter_driverの実装を見ながらこうしたらできるのかなぁとか検討してほぼ同じ解に最終的に行き着いた（これはAppiumを触ったことがあったから）ので、appium_flutter_driverでできるならDart VM Extensionで何なりとできるんだろうなぁとは思っている。


### 7. Dart AST

#### セッションメモ

- analyzer ASTとKernel ASTがあって、両方の共通のパッケージが`_fe_analyzer_shared`
    - 最近見たissueに、[_fe_analyzer_sharedのバージョンがモノレポ内で異なるとcustom_lintが変だよ](https://github.com/invertase/dart_custom_lint/issues/79)というのがあったのですが、`_fe_analyzer_shared`が何なのか、`pubspec.lock`では真っ先に出てくるので目にはするけどよく分かっていなかったのでした。そんな役割やったんやね！となりました
- `Scanner`や`Parser`などがあり、Parserは「ここから〇〇だよ」とか「見つかったよ」を逐次イベント送信する。
- `analyzer`パッケージはASTの情報に加えて元のソースの位置を持っているので、CST（具象構文木）に近い
- analyzerの役割としては型情報などが欲しいが、ASTは持っていない。このためにanalyzerではResolvedAST（型や識別子、Elementを持つ）になる
- Elementは意味情報を保持する
- ASTは単純な構文木の解析だから文字列リテラルのコードを`parseString`できるが、Resolved ASTはファイルからの入力しか受け付けない
    - インポートとかの文脈（コンテキスト）が必要になる以上ファイルでないといけないというのは納得　型とかは別ファイルを読まないといけないわけだしそれって相対でも書かれるし

#### 感想

ちょっとしたbuild_runnerを自分で作ったり、custom_lintを作ったりすることはあった割に、この辺の理解がかなりあやふやだったので、個人的には一番ためになったセッションでした。

DartはリフレクションできるがFlutterはリフレクションできないという特性上、どうしても痒い所に手が届かないことがあるので、